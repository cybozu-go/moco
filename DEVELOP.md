# How to develop MOCO

- [Install aqua](#install-aqua)
- [Running tests](#running-tests)
- [Generated files](#generated-files)
- [Testing with unreleased moco-agent](#testing-with-unreleased-moco-agent)
- [Updating MySQL binaries in moco-backup](#updating-mysql-binaries-in-moco-backup)
- [Updating tools used for tests](#updating-tools-used-for-tests)
- [Adding or dropping supported software versions](#adding-or-dropping-supported-software-versions)
- [Updating moco-agent](#updating-moco-agent)
- [Updating fluent-bit](#updating-fluent-bit)
- [Updating mysqld\_exporter](#updating-mysqld_exporter)

## Install aqua

This project uses [aqua](https://aquaproj.github.io/) to manage development tools. Before starting development, please install aqua by following the instructions at https://aquaproj.github.io/docs/install.

Once aqua is installed, the required development tools will be automatically installed when you run make commands.

## Running tests

MOCO has the following 4 kinds of tests:

1. Tests that do not depend on MySQL or Kubernetes
2. `pkg/dbop` and `pkg/bkop` tests that depend on MySQL version
3. Tests that depend on Kubernetes and therefore run by `controller-runtime`'s [envtest][envtest]
4. End-to-end tests

To run these tests, use the following make targets respectively:

1. `make test`
2. `make test-dbop test-bkop`
3. `make envtest`
4. Read [`e2e/README.md`](e2e/README.md)

## Generated files

Some files in the repository are auto-generated.

- `docs/crd_*.md` are generated by `make apidoc`.
- Some files under `config` are generated by `make manifests`.
- `api/**/*.deepcopy.go` are generated by `make generate`.

CI checks and fails if they need to be rebuilt.

## Testing with unreleased moco-agent

MOCO depends on [moco-agent][] that is released from a different repository.
The dependency is therefore managed in `go.mod` file.

To run e2e tests with an unreleased moco-agent, follow the instructions in
[`e2e/README.md`](e2e/README.md).

In case you need to use the new API set of unreleased moco-agent, use
[`replace`](https://golang.org/ref/mod#go-mod-file-replace) directive in `go.mod`
to reference the local source code.

## Updating MySQL binaries in moco-backup

Edit the following lines in `Dockerfile`:

```
# The tag should be the latest one
FROM ghcr.io/cybozu-go/moco/mysql:8.4.6.1 as mysql

# See the below description for how to get the version string.
ARG MYSQLSH_VERSION=8.4.6-1
```

The MySQL shell debian package can be found in https://dev.mysql.com/downloads/shell/ .

1. Choose "Ubuntu Linux"
2. Choose `mysql-shell_*ubuntu*_amd64.deb` (not a `dbgsym` image) and click "Download" button.
3. Copy the URL from the link whose text reads `No thanks, just start my download.`.
4. Update `MYSQLSH_VERSION` in `Dockerfile`.

## Updating tools used for tests

Edit [`Makefile`](Makefile) and [`e2e/Makefile`](e2e/Makefile).
Tool versions are defined at the top of them.

## Adding or dropping supported software versions

Edit matrix strategies in [`.github/workflows/ci.yaml`](.github/workflows/ci.yaml).
Also, don't forget to update [`README.md`](README.md).

MySQL versions appear twice:

```yaml
  dbtest:
    name: Integration tests with MySQL
    strategy:
      matrix:
        mysql-version: ["8.0.28", "8.0.41", "8.0.42", "8.0.43", "8.4.4", "8.4.6"]
...
  # Matrix tests for the latest MySQL version on different Kubernetes versions.
  e2e:
    name: Supported Kubernetes versions End-to-End Tests
    strategy:
      matrix:
        mysql-version: ["8.4.6"]
        k8s-version: ["1.30.4", "1.31.0", "1.32.0"]
...
  # Matrix tests for different MySQL versions on the latest supported Kubernetes version.
  e2e-mysql:
    name: Supported MySQL versions End-to-End Tests
    strategy:
      matrix:
        mysql-version: ["8.0.28", "8.0.41", "8.0.42", "8.0.43", "8.4.4", "8.4.6"]
        k8s-version: ["1.32.0"]
```

## Updating moco-agent

Run `go get github.com/cybozu-go/moco-agent@latest`.

## Updating fluent-bit

Edit `FluentBitImage` in [`version.go`](version.go).

## Updating mysqld_exporter

Edit `ExporterImage` in [`version.go`](version.go).

[moco-agent]: https://github.com/cybozu-go/moco-agent
[envtest]: https://pkg.go.dev/sigs.k8s.io/controller-runtime/pkg/envtest
