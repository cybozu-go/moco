<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Usage - MOCO Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-42563478.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-d2f0ab44.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">MOCO Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/cybozu-go/moco" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>
                        <a href="https://github.com/cybozu-go/moco/edit/main/docs/./usage.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <span class=fa-svg id="git-edit-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M421.7 220.3l-11.3 11.3-22.6 22.6-205 205c-6.6 6.6-14.8 11.5-23.8 14.1L30.8 511c-8.4 2.5-17.5 .2-23.7-6.1S-1.5 489.7 1 481.2L38.7 353.1c2.6-9 7.5-17.2 14.1-23.8l205-205 22.6-22.6 11.3-11.3 33.9 33.9 62.1 62.1 33.9 33.9zM96 353.9l-9.3 9.3c-.9 .9-1.6 2.1-2 3.4l-25.3 86 86-25.3c1.3-.4 2.5-1.1 3.4-2l9.3-9.3H112c-8.8 0-16-7.2-16-16V353.9zM453.3 19.3l39.4 39.4c25 25 25 65.5 0 90.5l-14.5 14.5-22.6 22.6-11.3 11.3-33.9-33.9-62.1-62.1L314.3 67.7l11.3-11.3 22.6-22.6 14.5-14.5c25-25 65.5-25 90.5 0z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="how-to-use-moco"><a class="header" href="#how-to-use-moco">How to use MOCO</a></h1>
<p>After <a href="setup.html">setting up MOCO</a>, you can create MySQL clusters with a custom resource called <a href="crd_mysqlcluster_v1beta2.html">MySQLCluster</a>.</p>
<ul>
<li><a href="#basics">Basics</a></li>
<li><a href="#limitations">Limitations</a>
<ul>
<li><a href="#errant-replicas">Errant replicas</a></li>
<li><a href="#read-only-primary">Read-only primary</a></li>
</ul>
</li>
<li><a href="#creating-clusters">Creating clusters</a>
<ul>
<li><a href="#creating-an-empty-cluster">Creating an empty cluster</a></li>
<li><a href="#creating-a-cluster-that-replicates-data-from-an-external-mysqld">Creating a cluster that replicates data from an external mysqld</a></li>
<li><a href="#bring-your-own-image">Bring your own image</a></li>
</ul>
</li>
<li><a href="#configurations">Configurations</a>
<ul>
<li><a href="#innodb-buffer-pool-size">InnoDB buffer pool size</a></li>
<li><a href="#opaque-configuration">Opaque configuration</a></li>
</ul>
</li>
<li><a href="#using-the-cluster">Using the cluster</a>
<ul>
<li><a href="#kubectl-moco"><code>kubectl moco</code></a></li>
<li><a href="#mysql-users">MySQL users</a></li>
<li><a href="#connecting-to-mysqld-over-network">Connecting to <code>mysqld</code> over network</a></li>
</ul>
</li>
<li><a href="#backup-and-restore">Backup and restore</a>
<ul>
<li><a href="#object-storage-bucket">Object storage bucket</a></li>
<li><a href="#backuppolicy">BackupPolicy</a></li>
<li><a href="#credentials-to-access-s3-bucket">Credentials to access S3 bucket</a></li>
<li><a href="#taking-an-emergency-backup">Taking an emergency backup</a></li>
<li><a href="#restore">Restore</a></li>
<li><a href="#further-details">Further details</a></li>
</ul>
</li>
<li><a href="#deleting-the-cluster">Deleting the cluster</a></li>
<li><a href="#status-metrics-and-logs">Status, metrics, and logs</a>
<ul>
<li><a href="#cluster-status">Cluster status</a></li>
<li><a href="#pod-status">Pod status</a></li>
<li><a href="#metrics">Metrics</a></li>
<li><a href="#logs">Logs</a></li>
</ul>
</li>
<li><a href="#maintenance">Maintenance</a>
<ul>
<li><a href="#increasing-the-number-of-instances-in-the-cluster">Increasing the number of instances in the cluster</a></li>
<li><a href="#switchover">Switchover</a></li>
<li><a href="#failover">Failover</a></li>
<li><a href="#upgrading-mysql-version">Upgrading mysql version</a></li>
<li><a href="#re-initializing-an-errant-replica">Re-initializing an errant replica</a></li>
<li><a href="#stop-clustering-and-reconciliation">Stop Clustering and Reconciliation</a></li>
<li><a href="#set-to-read-only">Set to Read Only</a></li>
</ul>
</li>
</ul>
<h2 id="basics"><a class="header" href="#basics">Basics</a></h2>
<p>MOCO creates a cluster of mysqld instances for each MySQLCluster.
A cluster can consists of 1, 3, or 5 mysqld instances.</p>
<p>MOCO configures <a href="https://dev.mysql.com/doc/refman/8.0/en/replication-semisync.html">semi-synchronous</a> <a href="https://dev.mysql.com/doc/refman/8.0/en/replication-gtids.html">GTID</a>-based replication between mysqld instances in a cluster if the cluster size is 3 or 5.  A 3-instance cluster can tolerate up to 1 replica failure, and a 5-instance cluster can tolerate up to 2 replica failures.</p>
<p>In a cluster, there is only one instance called <em>primary</em>.  The primary instance is the source of truth.  It is the only writable instance in the cluster, and the source of the replication.  All other instances are called <em>replica</em>.  A replica is a read-only instance and replicates data from the primary.</p>
<h2 id="limitations"><a class="header" href="#limitations">Limitations</a></h2>
<h3 id="errant-replicas"><a class="header" href="#errant-replicas">Errant replicas</a></h3>
<p>An inherent limitation of GTID-based semi-synchronous replication is that a failed instance would have <a href="https://www.percona.com/blog/2014/05/19/errant-transactions-major-hurdle-for-gtid-based-failover-in-mysql-5-6/">errant transactions</a>.  If this happens, the instance needs to be re-created by removing all data.</p>
<p>MOCO does not re-create such an instance.  It only detects instances having errant transactions and excludes them from the cluster.  Users need to monitor them and re-create the instances.</p>
<h3 id="read-only-primary"><a class="header" href="#read-only-primary">Read-only primary</a></h3>
<p>MOCO from time to time sets the primary mysqld instance read-only for a switchover or other reasons.
Applications that use MOCO MySQL need to be aware of this.</p>
<h2 id="creating-clusters"><a class="header" href="#creating-clusters">Creating clusters</a></h2>
<h3 id="creating-an-empty-cluster"><a class="header" href="#creating-an-empty-cluster">Creating an empty cluster</a></h3>
<p>An empty cluster always has a writable instance called <em>the primary</em>.  All other instances are called <em>replicas</em>.  Replicas are read-only and replicate data from the primary.</p>
<p>The following YAML is to create a three-instance cluster.  It has an anti-affinity for Pods so that all instances will be scheduled to different Nodes.  It also sets the limits for memory and CPU to make the Pod <a href="https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/">Guaranteed</a>.</p>
<pre><code class="language-yaml">apiVersion: moco.cybozu.com/v1beta2
kind: MySQLCluster
metadata:
  namespace: default
  name: test
spec:
  # replicas is the number of mysqld Pods.  The default is 1.
  replicas: 3
  podTemplate:
    spec:
      # Make the data directory writable. If moco-init fails with "Permission denied", uncomment the following settings.
      # securityContext:
      #   fsGroup: 10000
      #   fsGroupChangePolicy: "OnRootMismatch"  # available since k8s 1.20
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                - mysql
              - key: app.kubernetes.io/instance
                operator: In
                values:
                - test
            topologyKey: "kubernetes.io/hostname"
      containers:
      # At least a container named "mysqld" must be defined.
      - name: mysqld
        image: ghcr.io/cybozu-go/moco/mysql:8.4.8
        # By limiting CPU and memory, Pods will have Guaranteed QoS class.
        # requests can be omitted; it will be set to the same value as limits.
        resources:
          limits:
            cpu: "10"
            memory: "10Gi"
  volumeClaimTemplates:
  # At least a PVC named "mysql-data" must be defined.
  - metadata:
      name: mysql-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 1Gi
</code></pre>
<p>By default, MOCO uses <code>preferredDuringSchedulingIgnoredDuringExecution</code> to prevent Pods from being placed on the same Node.</p>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: moco-&lt;MYSQLCLSTER_NAME&gt;
  namespace: default
...
spec:
  template:
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                  - mysql
                - key: app.kubernetes.io/created-by
                  operator: In
                  values:
                  - moco
                - key: app.kubernetes.io/instance
                  operator: In
                  values:
                  - &lt;MYSQLCLSTER_NAME&gt;
              topologyKey: kubernetes.io/hostname
            weight: 100
...
</code></pre>
<p>There are other example manifests in <a href="https://github.com/cybozu-go/moco/tree/main/examples"><code>examples</code></a> directory.</p>
<p>The complete reference of MySQLCluster is <a href="crd_mysqlcluster_v1beta2.html"><code>crd_mysqlcluster_v1beta2.md</code></a>.</p>
<h3 id="creating-a-cluster-that-replicates-data-from-an-external-mysqld"><a class="header" href="#creating-a-cluster-that-replicates-data-from-an-external-mysqld">Creating a cluster that replicates data from an external mysqld</a></h3>
<p>Let’s call the source mysqld instance <em>donor</em>.</p>
<p>First, make sure <code>partial_revokes</code> is enabled <strong>on the donor</strong>; Replicating data from the donor with <code>partial_revokes</code> disabled will <a href="https://dev.mysql.com/doc/refman/8.0/en/partial-revokes.html#partial-revokes-replication">result in replication inconsistencies or errors</a> since MOCO uses <code>partial_revokes</code> functionality.</p>
<p>We use <a href="https://dev.mysql.com/doc/refman/8.0/en/clone-plugin.html">the clone plugin</a> to copy the whole data quickly.
After the cloning, MOCO needs to create some user accounts and install plugins.</p>
<p><strong>On the donor</strong>, you need to install the plugin and create two user accounts as follows:</p>
<pre><code class="language-console">mysql&gt; INSTALL PLUGIN clone SONAME 'mysql_clone.so';
mysql&gt; CREATE USER 'clone-donor'@'%' IDENTIFIED BY 'xxxxxxxxxxx';
mysql&gt; GRANT BACKUP_ADMIN, REPLICATION SLAVE ON *.* TO 'clone-donor'@'%';
mysql&gt; CREATE USER 'clone-init'@'localhost' IDENTIFIED BY 'yyyyyyyyyyy';
mysql&gt; GRANT ALL ON *.* TO 'clone-init'@'localhost' WITH GRANT OPTION;
mysql&gt; GRANT PROXY ON ''@'' TO 'clone-init'@'localhost' WITH GRANT OPTION;
</code></pre>
<p>You may change the user names and should change their passwords.</p>
<p>Then create a Secret in the same namespace as MySQLCluster:</p>
<pre><code class="language-console">$ kubectl -n &lt;namespace&gt; create secret generic donor-secret \
    --from-literal=HOST=&lt;donor-host&gt; \
    --from-literal=PORT=&lt;donor-port&gt; \
    --from-literal=USER=clone-donor \
    --from-literal=PASSWORD=xxxxxxxxxxx \
    --from-literal=INIT_USER=clone-init \
    --from-literal=INIT_PASSWORD=yyyyyyyyyyy
</code></pre>
<p>You may change the secret name.</p>
<p>Finally, create MySQLCluster with <code>spec.replicationSourceSecretName</code> set to the Secret name as follows.
The mysql image must be the same version as the donor’s.</p>
<pre><code class="language-yaml">apiVersion: moco.cybozu.com/v1beta2
kind: MySQLCluster
metadata:
  namespace: foo
  name: test
spec:
  replicationSourceSecretName: donor-secret
  podTemplate:
    spec:
      containers:
      - name: mysqld
        image: ghcr.io/cybozu-go/moco/mysql:8.4.8  # must be the same version as the donor
  volumeClaimTemplates:
  - metadata:
      name: mysql-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 1Gi
</code></pre>
<p>To stop the replication from the donor, update MySQLCluster with <code>spec.replicationSourceSecretName: null</code>.</p>
<h3 id="bring-your-own-image"><a class="header" href="#bring-your-own-image">Bring your own image</a></h3>
<p>We provide pre-built MySQL container images at <a href="https://github.com/cybozu-go/moco/pkgs/container/moco%2Fmysql">ghcr.io/cybozu-go/moco/mysql</a>.
If you want to build and use your own image, read <a href="custom-mysqld.html"><code>custom-mysqld.md</code></a>.</p>
<h2 id="configurations"><a class="header" href="#configurations">Configurations</a></h2>
<p>The default and constant configuration values for <code>mysqld</code> are available on <a href="https://pkg.go.dev/github.com/cybozu-go/moco/pkg/mycnf#pkg-variables">pkg.go.dev</a>.
The settings in <code>ConstMycnf</code> cannot be changed while the settings in <code>DefaultMycnf</code> can be overridden.</p>
<p>You can change the default values or set undefined values by creating a ConfigMap in the same namespace as MySQLCluster, and setting <code>spec.mysqlConfigMapName</code> in MySQLCluster to the name of the ConfigMap as follows:</p>
<pre><code class="language-yaml">apiVersion: v1
kind: ConfigMap
metadata:
  namespace: foo
  name: mycnf
data:
  long_query_time: "5"
  innodb_buffer_pool_size: "10G"
---
apiVersion: moco.cybozu.com/v1beta2
kind: MySQLCluster
metadata:
  namespace: foo
  name: test
spec:
  # set this to the name of ConfigMap
  mysqlConfigMapName: mycnf
  ...
</code></pre>
<h3 id="innodb-buffer-pool-size"><a class="header" href="#innodb-buffer-pool-size">InnoDB buffer pool size</a></h3>
<p>If <code>innodb_buffer_pool_size</code> is not specified, MOCO sets it automatically to 70% of the value of <code>resources.requests.memory</code> (or <code>resources.limits.memory</code>) for <code>mysqld</code> container.</p>
<p>If both <code>resources.request.memory</code> and <code>resources.limits.memory</code> are not set, <code>innodb_buffer_pool_size</code> will be set to <code>128M</code>.</p>
<h3 id="opaque-configuration"><a class="header" href="#opaque-configuration">Opaque configuration</a></h3>
<p>Some configuration variables cannot be fully configured with ConfigMap values.
For example, <a href="https://dev.mysql.com/doc/refman/8.0/en/performance-schema-startup-configuration.html"><code>--performance-schema-instrument</code></a> needs to be specified multiple times.</p>
<p>You may set them through a special config key <code>_include</code>.
The value of <code>_include</code> will be included in <code>my.cnf</code> as opaque.</p>
<pre><code class="language-yaml">apiVersion: v1
kind: ConfigMap
metadata:
  namespace: foo
  name: mycnf
data:
  _include: |
    performance-schema-instrument='memory/%=ON'
    performance-schema-instrument='wait/synch/%/innodb/%=ON'
    performance-schema-instrument='wait/lock/table/sql/handler=OFF'
    performance-schema-instrument='wait/lock/metadata/sql/mdl=OFF'
</code></pre>
<p>Care must be taken not to overwrite critical configurations such as <code>log_bin</code> since MOCO does not check the contents from <code>_include</code>.</p>
<h2 id="using-the-cluster"><a class="header" href="#using-the-cluster">Using the cluster</a></h2>
<h3 id="kubectl-moco"><a class="header" href="#kubectl-moco"><code>kubectl moco</code></a></h3>
<p>From outside of your Kubernetes cluster, you can access MOCO MySQL instances using <code>kubectl-moco</code>.
<code>kubectl-moco</code> is <a href="https://kubernetes.io/docs/tasks/extend-kubectl/kubectl-plugins/">a plugin for <code>kubectl</code></a>.
Pre-built binaries are available on <a href="https://github.com/cybozu-go/moco/releases/latest">GitHub releases</a>.</p>
<p>The following is an example to run <code>mysql</code> command interactively to access the primary instance of <code>test</code> MySQLCluster in <code>foo</code> namespace.</p>
<pre><code class="language-console">$ kubectl moco -n foo mysql -it test
</code></pre>
<p>Read <a href="kubectl-moco.html">the reference manual of <code>kubectl-moco</code></a> for further details and examples.</p>
<h3 id="mysql-users"><a class="header" href="#mysql-users">MySQL users</a></h3>
<p>MOCO prepares a set of users.</p>
<ul>
<li><code>moco-readonly</code> can read all tables of all databases.</li>
<li><code>moco-writable</code> can create users, databases, or tables.</li>
<li><code>moco-admin</code> is the super user.</li>
</ul>
<p>The exact privileges that <code>moco-readonly</code> has are:</p>
<ul>
<li>PROCESS</li>
<li>REPLICATION CLIENT</li>
<li>REPLICATION SLAVE</li>
<li>SELECT</li>
<li>SHOW DATABASES</li>
<li>SHOW VIEW</li>
</ul>
<p>The exact privileges that <code>moco-writable</code> has are:</p>
<ul>
<li>ALTER</li>
<li>ALTER ROUTINE</li>
<li>CREATE</li>
<li>CREATE ROLE</li>
<li>CREATE ROUTINE</li>
<li>CREATE TEMPORARY TABLES</li>
<li>CREATE USER</li>
<li>CREATE VIEW</li>
<li>DELETE</li>
<li>DROP</li>
<li>DROP ROLE</li>
<li>EVENT</li>
<li>EXECUTE</li>
<li>INDEX</li>
<li>INSERT</li>
<li>LOCK TABLES</li>
<li>PROCESS</li>
<li>REFERENCES</li>
<li>REPLICATION CLIENT</li>
<li>REPLICATION SLAVE</li>
<li>SELECT</li>
<li>SHOW DATABASES</li>
<li>SHOW VIEW</li>
<li>TRIGGER</li>
<li>UPDATE</li>
</ul>
<p><code>moco-writable</code> cannot edit tables in <code>mysql</code> database, though.</p>
<p>You can create other users and grant them certain privileges as either <code>moco-writable</code> or <code>moco-admin</code>.</p>
<pre><code class="language-console">$ kubectl moco mysql -u moco-writable test -- -e "CREATE USER 'foo'@'%' IDENTIFIED BY 'bar'"
$ kubectl moco mysql -u moco-writable test -- -e "CREATE DATABASE db1"
$ kubectl moco mysql -u moco-writable test -- -e "GRANT ALL ON db1.* TO 'foo'@'%'"
</code></pre>
<h3 id="connecting-to-mysqld-over-network"><a class="header" href="#connecting-to-mysqld-over-network">Connecting to <code>mysqld</code> over network</a></h3>
<p>MOCO prepares two Services for each MySQLCluster.
For example, a MySQLCluster named <code>test</code> in <code>foo</code> Namespace has the following Services.</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Service Name</th><th>DNS Name</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>moco-test-primary</code></td><td><code>moco-test-primary.foo.svc</code></td><td>Connect to the primary instance.</td></tr>
<tr><td><code>moco-test-replica</code></td><td><code>moco-test-replica.foo.svc</code></td><td>Connect to replica instances.</td></tr>
</tbody>
</table>
</div>
<p><code>moco-test-replica</code> can be used only for read access.</p>
<p>The type of these Services is usually ClusterIP.
The following is an example to change Service type to LoadBalancer and add an annotation for <a href="https://metallb.universe.tf/">MetalLB</a>.</p>
<pre><code class="language-yaml">apiVersion: moco.cybozu.com/v1beta2
kind: MySQLCluster
metadata:
  namespace: foo
  name: test
spec:
  primaryServiceTemplate:
    metadata:
      annotations:
        metallb.universe.tf/address-pool: production-public-ips
    spec:
      type: LoadBalancer
...
</code></pre>
<h2 id="backup-and-restore"><a class="header" href="#backup-and-restore">Backup and restore</a></h2>
<p>MOCO can take full and incremental backups regularly.
The backup data are stored in <a href="https://aws.amazon.com/s3/">Amazon S3</a> compatible object storages.</p>
<p>You can restore data from a backup to a new MySQL cluster.</p>
<h3 id="object-storage-bucket"><a class="header" href="#object-storage-bucket">Object storage bucket</a></h3>
<p>Bucket is a management unit of objects in S3.  MOCO stores backups in a specified bucket.</p>
<p>MOCO does not remove backups.
To remove old backups automatically, you can set a lifecycle configuration to the bucket.</p>
<p>ref: <a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/how-to-set-lifecycle-configuration-intro.html">Setting lifecycle configuration on a bucket</a></p>
<p>A bucket can be shared safely across multiple MySQLClusters.
Object keys are prefixed with <code>moco/</code>.</p>
<h3 id="backuppolicy"><a class="header" href="#backuppolicy">BackupPolicy</a></h3>
<p><a href="crd_backuppolicy_v1beta2.html">BackupPolicy</a> is a custom resource to define a policy for taking backups.</p>
<p>The following is an example BackupPolicy to take a backup every day and store data in <a href="https://min.io/">MinIO</a>:</p>
<pre><code class="language-yaml">apiVersion: moco.cybozu.com/v1beta2
kind: BackupPolicy
metadata:
  namespace: backup
  name: daily
spec:
  # Backup schedule.  Any CRON format is allowed.
  schedule: "@daily"

  jobConfig:
    # An existing ServiceAccount name is required.
    serviceAccountName: backup-owner
    env:
    - name: AWS_ACCESS_KEY_ID
      value: minioadmin
    - name: AWS_SECRET_ACCESS_KEY
      value: minioadmin
    # bucketName is required. Other fields are optional.
    # If backendType is s3 (default), specify the region of the bucket via region filed or AWS_REGION environment variable.
    bucketConfig:
      bucketName: moco
      region: us-east-1
      endpointURL: http://minio.default.svc:9000
      usePathStyle: true
    # MOCO uses a filesystem volume to store data temporarily.
    workVolume:
      # Using emptyDir as a working directory is NOT recommended.
      # The recommended way is to use generic ephemeral volume with a provisioner
      # that can provide enough capacity.
      # https://kubernetes.io/docs/concepts/storage/ephemeral-volumes/#generic-ephemeral-volumes
      emptyDir: {}
</code></pre>
<p>To enable backup for a MySQLCluster, reference the BackupPolicy name like this:</p>
<pre><code class="language-yaml">apiVersion: moco.cybozu.com/v1beta2
kind: MySQLCluster
metadata:
  namespace: default
  name: foo
spec:
  backupPolicyName: daily  # The policy name
...
</code></pre>
<blockquote>
<p><strong>Note:</strong> If you want to specify the ObjectBucket name in a ConfigMap or Secret, you can use <code>envFrom</code> and specify the environment variable name in <code>jobConfig.bucketConfig.bucketName</code> as follows.
This behavior is tested.</p>
</blockquote>
<pre><code class="language-yaml">apiVersion: moco.cybozu.com/v1beta2
kind: BackupPolicy
metadata:
  namespace: backup
  name: daily
spec:
  jobConfig:
    bucketConfig:
      bucketName: "$(BUCKET_NAME)"
      region: us-east-1
      endpointURL: http://minio.default.svc:9000
      usePathStyle: true
    envFrom:
    - configMapRef:
        name: bucket-name
...
---
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: backup
  name: bucket-name
data:
  BUCKET_NAME: moco
</code></pre>
<p>MOCO creates a <a href="https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/">CronJob</a> for each MySQLCluster that has <code>spec.backupPolicyName</code>.</p>
<p>The CronJob’s name is <code>moco-backup-</code> + the name of MySQLCluster.
For the above example, a CronJob named <code>moco-backup-foo</code> is created in <code>default</code> namespace.</p>
<p>The following podAntiAffinity is set by default for CronJob.
If you want to override it, set <code>BackupPolicy.spec.jobConfig.affinity</code>.</p>
<pre><code class="language-yaml">apiVersion: batch/v1
kind: CronJob
metadata:
  name: moco-backup-foo
spec:
...
  jobTemplate:
    spec:
      template:
        spec:
          affinity:
            podAntiAffinity:
              preferredDuringSchedulingIgnoredDuringExecution:
                - podAffinityTerm:
                    labelSelector:
                      matchExpressions:
                        - key: app.kubernetes.io/name
                          operator: In
                          values:
                            - mysql-backup
                        - key: app.kubernetes.io/created-by
                          operator: In
                          values:
                            - moco
                    topologyKey: kubernetes.io/hostname
                  weight: 100
...
</code></pre>
<h3 id="credentials-to-access-s3-bucket"><a class="header" href="#credentials-to-access-s3-bucket">Credentials to access S3 bucket</a></h3>
<p>Depending on your Kubernetes service provider and object storage, there are various ways to give credentials to access the object storage bucket.</p>
<p>For Amazon’s <a href="https://aws.amazon.com/eks/">Elastic Kubernetes Service (EKS)</a> and S3 users, the easiest way is probably to use <a href="https://aws.github.io/aws-eks-best-practices/security/docs/iam/#iam-roles-for-service-accounts-irsa">IAM Roles for Service Accounts (IRSA)</a>.</p>
<p>ref: <a href="https://www.eksworkshop.com/beginner/110_irsa/">IAM ROLES FOR SERVICE ACCOUNTS</a></p>
<p>Another popular way is to set <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code> environment variables as shown in the above example.</p>
<h3 id="taking-an-emergency-backup"><a class="header" href="#taking-an-emergency-backup">Taking an emergency backup</a></h3>
<p>You can take an emergency backup by creating a Job from the CronJob for backup.</p>
<pre><code class="language-console">$ kubectl create job --from=cronjob/moco-backup-foo emergency-backup
</code></pre>
<h3 id="restore"><a class="header" href="#restore">Restore</a></h3>
<p>To restore data from a backup, create a new MyQLCluster with <code>spec.restore</code> field as follows:</p>
<pre><code class="language-yaml">apiVersion: moco.cybozu.com/v1beta2
kind: MySQLCluster
metadata:
  namespace: backup
  name: target
spec:
  # restore field is not editable.
  # to modify parameters, delete and re-create MySQLCluster.
  restore:
    # The source MySQLCluster's name and namespace
    sourceName: source
    sourceNamespace: backup

    # The restore point-in-time in RFC3339 format.
    restorePoint: "2021-05-26T12:34:56Z"

    # jobConfig is the same in BackupPolicy
    jobConfig:
      serviceAccountName: backup-owner
      env:
      - name: AWS_ACCESS_KEY_ID
        value: minioadmin
      - name: AWS_SECRET_ACCESS_KEY
        value: minioadmin
      bucketConfig:
        bucketName: moco
        region: us-east-1
        endpointURL: http://minio.default.svc:9000
        usePathStyle: true
      workVolume:
        emptyDir: {}
...
</code></pre>
<h3 id="further-details"><a class="header" href="#further-details">Further details</a></h3>
<p>Read <a href="backup.html">backup.md</a> for further details.</p>
<h2 id="deleting-the-cluster"><a class="header" href="#deleting-the-cluster">Deleting the cluster</a></h2>
<p>By deleting MySQLCluster, all resources <strong>including PersistentVolumeClaims</strong> generated from the templates are automatically removed.</p>
<p>If you want to keep the PersistentVolumeClaims, remove <code>metadata.ownerReferences</code> from them before you delete a MySQLCluster.</p>
<h2 id="status-metrics-and-logs"><a class="header" href="#status-metrics-and-logs">Status, metrics, and logs</a></h2>
<h3 id="cluster-status"><a class="header" href="#cluster-status">Cluster status</a></h3>
<p>You can see the health and availability status of MySQLCluster as follows:</p>
<pre><code class="language-console">$ kubectl get mysqlcluster
NAME   AVAILABLE   HEALTHY   PRIMARY   SYNCED REPLICAS   ERRANT REPLICAS
test   True        True      0         3
</code></pre>
<ul>
<li>The cluster is available when the primary Pod is running and ready.</li>
<li>The cluster is healthy when there is no problems.</li>
<li><code>PRIMARY</code> is the index of the current primary instance Pod.</li>
<li><code>SYNCED REPLICAS</code> is the number of ready Pods.</li>
<li><code>ERRANT REPLICAS</code> is the number of instances having errant transactions.</li>
</ul>
<p>You can also use <code>kubectl describe mysqlcluster</code> to see the recent events on the cluster.</p>
<h3 id="pod-status"><a class="header" href="#pod-status">Pod status</a></h3>
<p>MOCO adds mysqld containers a liveness probe and a readiness probe to check the replication status in addition to the process status.</p>
<p>A replica Pod is <em>ready</em> only when it is replicating data from the primary without a significant delay.
The default threshold of the delay is 60 seconds.  The threshold can be configured as follows.</p>
<pre><code class="language-yaml">apiVersion: moco.cybozu.com/v1beta2
kind: MySQLCluster
metadata:
  namespace: foo
  name: test
spec:
  maxDelaySeconds: 180
  ...
</code></pre>
<p>Unready replica Pods are automatically excluded from the load-balancing targets so that users will not see too old  data.</p>
<h3 id="metrics"><a class="header" href="#metrics">Metrics</a></h3>
<p>MOCO provides a built-in support to collect and expose <code>mysqld</code> metrics using <a href="https://github.com/prometheus/mysqld_exporter/">mysqld_exporter</a>.</p>
<p>This is an example YAML to enable <code>mysqld_exporter</code>.
<code>spec.collectors</code> is a list of <code>mysqld_exporter</code> flag names without <code>collect.</code> prefix.</p>
<pre><code class="language-yaml">apiVersion: moco.cybozu.com/v1beta2
kind: MySQLCluster
metadata:
  namespace: foo
  name: test
spec:
  collectors:
  - engine_innodb_status
  - info_schema.innodb_metrics
  podTemplate:
    ...
</code></pre>
<p>See <a href="metrics.html"><code>metrics.md</code></a> for all available metrics and how to collect them using Prometheus.</p>
<h3 id="logs"><a class="header" href="#logs">Logs</a></h3>
<p>Error logs from <code>mysqld</code> can be viewed as follows:</p>
<pre><code class="language-console">$ kubectl logs moco-test-0 mysqld
</code></pre>
<p>Slow logs from <code>mysqld</code> can be viewed as follows:</p>
<pre><code class="language-console">$ kubectl logs moco-test-0 slow-log
</code></pre>
<h2 id="maintenance"><a class="header" href="#maintenance">Maintenance</a></h2>
<h3 id="increasing-the-number-of-instances-in-the-cluster"><a class="header" href="#increasing-the-number-of-instances-in-the-cluster">Increasing the number of instances in the cluster</a></h3>
<p>Edit <code>spec.replicas</code> field of MySQLCluster:</p>
<pre><code class="language-yaml">apiVersion: moco.cybozu.com/v1beta2
kind: MySQLCluster
metadata:
  namespace: foo
  name: test
spec:
  replicas: 5
  ...
</code></pre>
<p>You can only increase the number of instances in a MySQLCluster from 1 to 3 or 5, or from 3 to 5.
Decreasing the number of instances is not allowed.</p>
<h3 id="switchover"><a class="header" href="#switchover">Switchover</a></h3>
<p>Switchover is an operation to change the live primary to one of the replicas.</p>
<p>MOCO automatically switch the primary when the Pod of the primary instance is to be deleted.</p>
<p>Users can manually trigger a switchover with <code>kubectl moco switchover CLUSTER_NAME</code>.
Read <a href="kubectl-moco.html"><code>kubectl-moco.md</code></a> for details.</p>
<h3 id="failover"><a class="header" href="#failover">Failover</a></h3>
<p>Failover is an operation to replace the dead primary with the most advanced replica.
MOCO automatically does this as soon as it detects that the primary is down.</p>
<p>The most advanced replica is a replica who has retrieved the most up-to-date transaction from the dead primary.
Since MOCO configures loss-less semi-synchronous replication, the failover is guaranteed not to lose any user data.</p>
<p>After a failover, the old primary may become an errant replica <a href="#errant-replicas">as described</a>.</p>
<h3 id="upgrading-mysql-version"><a class="header" href="#upgrading-mysql-version">Upgrading mysql version</a></h3>
<p>You can upgrade the MySQL version of a MySQL cluster as follows:</p>
<ol>
<li>Check that the cluster is healthy.</li>
<li>Check release notes of MySQL for any incompatibilities between the current and the new versions.</li>
<li>Edit the Pod template of the MySQLCluster and update <code>mysqld</code> container image:</li>
</ol>
<pre><code class="language-yaml">apiVersion: moco.cybozu.com/v1beta2
kind: MySQLCluster
metadata:
  namespace: default
  name: test
spec:
      containers:
      - name: mysqld
        # Edit the next line
        image: ghcr.io/cybozu-go/moco/mysql:8.4.8
</code></pre>
<p>You are advised to make backups and/or create a replica cluster before starting the upgrade process.
Read <a href="upgrading.html"><code>upgrading.md</code></a> for further details.</p>
<h3 id="re-initializing-an-errant-replica"><a class="header" href="#re-initializing-an-errant-replica">Re-initializing an errant replica</a></h3>
<p>Delete the PVC and Pod of the errant replica, like this:</p>
<pre><code class="language-console">$ kubectl delete --wait=false pvc mysql-data-moco-test-0
$ kubectl delete --grace-period=1 pods moco-test-0
</code></pre>
<p>Depending on your Kubernetes version, StatefulSet controller may create a pending Pod before PVC gets deleted.
Delete such pending Pods until PVC is actually removed.</p>
<h3 id="stop-clustering-and-reconciliation"><a class="header" href="#stop-clustering-and-reconciliation">Stop Clustering and Reconciliation</a></h3>
<p>In MOCO, you can optionally stop the clustering and reconciliation of a MySQLCluster.</p>
<p>To stop clustering and reconciliation, use the following commands.</p>
<pre><code class="language-console">$ kubectl moco stop clustering &lt;CLSUTER_NAME&gt;
$ kubectl moco stop reconciliation &lt;CLSUTER_NAME&gt;
</code></pre>
<p>To resume the stopped clustering and reconciliation, use the following commands.</p>
<pre><code class="language-console">$ kubectl moco start clustering &lt;CLSUTER_NAME&gt;
$ kubectl moco start reconciliation &lt;CLSUTER_NAME&gt;
</code></pre>
<p>You could use this feature in the following cases:</p>
<ol>
<li>To stop the replication of a MySQLCluster and perform a manual operation to align the GTID
<ul>
<li>Run the <code>kubectl moco stop clustering</code> command on the MySQLCluster where you want to stop the replication</li>
</ul>
</li>
<li>To suppress the full update of MySQLCluster that occurs during the upgrade of MOCO
<ul>
<li>Run the <code>kubectl moco stop reconciliation</code> command on the MySQLCluster on which you want to suppress the update</li>
</ul>
</li>
</ol>
<p>To check whether clustering and reconciliation are stopped, use <code>kubectl get mysqlcluster</code>.
Moreover, while clustering is stopped, <code>AVAILABLE</code> and <code>HEALTHY</code> values will be <code>Unknown</code>.</p>
<pre><code class="language-console">$ kubectl get mysqlcluster
NAME   AVAILABLE   HEALTHY   PRIMARY   SYNCED REPLICAS   ERRANT REPLICAS   CLUSTERING ACTIVE   RECONCILE ACTIVE   LAST BACKUP
test   Unknown     Unknown   0         3                                   False               False              &lt;no value&gt;
</code></pre>
<p>The MOCO controller outputs the following metrics to indicate that clustering has been stopped.
1 if the cluster is clustering or reconciliation stopped, 0 otherwise.</p>
<pre><code class="language-text">moco_cluster_clustering_stopped{name="mycluster", namespace="mynamesapce"} 1
moco_cluster_reconciliation_stopped{name="mycluster", namespace="mynamesapce"} 1
</code></pre>
<p>During the stop of clustering, monitoring of the cluster from MOCO will be halted, and the value of the following metrics will become NaN.</p>
<pre><code class="language-text">moco_cluster_available{name="test",namespace="default"} NaN
moco_cluster_healthy{name="test",namespace="default"} NaN
moco_cluster_ready_replicas{name="test",namespace="default"} NaN
moco_cluster_errant_replicas{name="test",namespace="default"} NaN
</code></pre>
<h3 id="set-to-read-only"><a class="header" href="#set-to-read-only">Set to Read Only</a></h3>
<p>When you want to set MOCO’s MySQL to read-only, use the the following commands.</p>
<p>MOCO makes the primary instance writable in the clustering process.
Therefore, please be sure to stop clustering when you set it to read-only.</p>
<pre><code class="language-console">$ kubectl moco stop clustering &lt;CLSUTER_NAME&gt;
$ kubectl moco mysql -u moco-admin &lt;CLSUTER_NAME&gt; -- -e "SET GLOBAL super_read_only=1"
</code></pre>
<p>You can check whether the cluster is read-only with the following command.</p>
<pre><code class="language-console">$ kubectl moco mysql -it &lt;CLSUTER_NAME&gt; -- -e "SELECT @@super_read_only"
+-------------------+
| @@super_read_only |
+-------------------+
|                 1 |
+-------------------+
</code></pre>
<p>If you want to leave read-only mode, restart clustering as follows. Then, MOCO will make the cluster writable.</p>
<pre><code class="language-console">$ kubectl moco start clustering &lt;CLSUTER_NAME&gt;
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="install-plugin.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="advanced.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="install-plugin.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="advanced.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
