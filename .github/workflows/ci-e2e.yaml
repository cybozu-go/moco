name: E2E CI

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    types: [opened, synchronize]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  cache-version: 1

# CI tests with the Cybozu internal use version plus the latest and one previous MySQL version.
# Other MySQL supported versions tested weekly.
# see: weekly.yaml
#
# NOTE: Current Cybozu internal use version is 8.0.28.
jobs:
  dbtest:
    name: Integration tests with MySQL
    strategy:
      matrix:
        mysql-version: ["8.0.34", "8.0.35", "8.0.36"]
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Check and output changed files
        uses: tj-actions/changed-files@7fc073d92265804a8d4e4982b637dee053daf6c5 # v42.0.7
        id: changed-files
        with:
          files_ignore: |
            **/*.md
            containers/**
      - uses: ./.github/actions/dbtest
        with:
          mysql-version: ${{ matrix.mysql-version }}
        if: steps.changed-files.outputs.any_changed == 'true'

  e2e:
    name: Supported Kubernetes versions End-to-End Tests
    strategy:
      matrix:
        mysql-version: ["8.0.36"]
        k8s-version: ["1.26.14", "1.27.11", "1.28.7"]
    runs-on:
      group: moco
    steps:
      - uses: actions/checkout@v4
      - name: Check and output changed files
        uses: tj-actions/changed-files@7fc073d92265804a8d4e4982b637dee053daf6c5 # v42.0.7
        id: changed-files
        with:
          files_ignore: |
            **/*.md
            containers/**
      - uses: ./.github/actions/e2e
        with:
          k8s-version: ${{ matrix.k8s-version }}
          mysql-version: ${{ matrix.mysql-version }}
        if: steps.changed-files.outputs.any_changed == 'true'

  e2e-mysql:
    name: Supported MySQL versions End-to-End Tests
    strategy:
      matrix:
        mysql-version: ["8.0.34", "8.0.35", "8.0.36"]
        k8s-version: ["1.28.7"]
    runs-on:
      group: moco
    steps:
      - uses: actions/checkout@v4
      - name: Check and output changed files
        uses: tj-actions/changed-files@7fc073d92265804a8d4e4982b637dee053daf6c5 # v42.0.7
        id: changed-files
        with:
          files_ignore: |
            **/*.md
            containers/**
      - uses: ./.github/actions/e2e
        if: steps.changed-files.outputs.any_changed == 'true'
        with:
          k8s-version: ${{ matrix.k8s-version }}
          mysql-version: ${{ matrix.mysql-version }}

  upgrade:
    name: Upgrade Test
    runs-on:
      group: moco
    steps:
      - uses: actions/checkout@v4
      - name: Check and output changed files
        uses: tj-actions/changed-files@7fc073d92265804a8d4e4982b637dee053daf6c5 # v42.0.7
        id: changed-files
        with:
          files_ignore: |
            **/*.md
            containers/**
      - uses: ./.github/actions/upgrade
        if: steps.changed-files.outputs.any_changed == 'true'

  finish-e2e:
    name: Confirm finishing all tests
    runs-on: ubuntu-22.04
    needs:
    - dbtest
    - e2e
    - e2e-mysql
    - upgrade
    steps:
      - run: echo "OK"
